app: consultant
service: workout-composer
frameworkVersion: "4"

provider:
  name: aws
  runtime: nodejs20
  region: eu-central-1
  stage: dev

environment:
  WORKOUTS_BUCKET: !Ref WorkoutsBucket
  WORKOUTS_TABLE: !Ref WorkoutsTable

build:
  esbuild:
    platform: node
    bundle: true
    minify: false
    sourcemap: true
    target: node20
    keepNames: true
    exclude:
      - "@aws-sdk/*" # loaded from Lambda layer

plugins:
  - serverless-setup-functions

iam:
  role:
    statements:
      - Effect: "Allow"
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:DeleteObject
        Resource: !Sub "${WorkoutsBucket.Arn}/*"

      - Effect: "Allow"
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:Query
          - dynamodb:Scan
        Resource: !GetAtt WorkoutsTable.Arn

      - Effect: "Allow"
        Action:
          - states:StartExecution
        Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:WorkoutProcessorStateMachine-${self:provider.stage}"
