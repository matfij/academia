@using Microsoft.Maui.Controls
@using SkiaSharp
@using SkiaSharp.Views.Maui
@using MauiSkiaSharp.Services;

@inject ParticleService particleService;

@code {
    private SKCanvasView CanvasView = new()
        {
            WidthRequest = 1000,
            HeightRequest = 600,
        };

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            SetupCanvas();
        }
    }

    private void SetupCanvas()
    {
        CanvasView.EnableTouchEvents = true;
        CanvasView.PaintSurface += OnPaintSurface;
        CanvasView.Touch += OnTouch;
        var contentPage = Application.Current?.MainPage as ContentPage;
        if (contentPage != null)
        {
            contentPage.Content = CanvasView;
        }
    }

    private void OnPaintSurface(object? sender, SKPaintSurfaceEventArgs args)
    {
        var canvas = args.Surface.Canvas;
        canvas.Clear(SKColors.Black);

        using var paint = new SKPaint { Color = SKColors.White, IsAntialias = true };


        foreach (var particle in particleService.GetParticles)
        {
            canvas.DrawCircle(particle.X, particle.Y, particle.R, paint);
        }
    }

    private void OnTouch(object? sender, SKTouchEventArgs args)
    {
        if (args.ActionType != SKTouchAction.Pressed || args.MouseButton != SKMouseButton.Left)
        {
            return;
        }
        System.Diagnostics.Debug.WriteLine($"Canvas touched at ({args.Location.X} {args.Location.Y})");
        particleService.AddParticle(
        new Particle(
        (float)(10 * Math.Round((decimal)args.Location.X / 10)),
        (float)(10 * Math.Round((decimal)args.Location.Y / 10))
        ));
    }
}
